/**
 * Unit Tests - Prompt Command
 *
 * AC2: Command routing supports subcommands (prompt)
 * AC3: Argument parsing handles flags and options
 */
import 'reflect-metadata';
import { describe, it, expect, beforeEach, afterEach } from 'bun:test';
import { container } from 'tsyringe';
import { promptCommand } from '../../../src/commands/prompt.js';
import type { OutputWriter } from '../../../src/output.js';

// Mock OutputWriter
class MockOutputWriter implements OutputWriter {
  stdout(): void {
    /* Intentionally empty - stub for testing */
  }
  stderr(): void {
    /* Intentionally empty - stub for testing */
  }
  log(): void {
    /* Intentionally empty - stub for testing */
  }
  error(): void {
    /* Intentionally empty - stub for testing */
  }
}

describe('PromptCommand', () => {
  beforeEach(() => {
    container.clearInstances();
    container.register<OutputWriter>('OutputWriter', { useClass: MockOutputWriter });
  });

  afterEach(() => {
    container.clearInstances();
  });

  it('should have correct command name', () => {
    expect(promptCommand.command).toBe('prompt');
  });

  it('should have description', () => {
    expect(promptCommand.describe).toBeDefined();
    expect(typeof promptCommand.describe).toBe('string');
    expect(promptCommand.describe as string)?.length).toBeGreaterThan(0);
  });

  it('should define builder function', () => {
    expect(promptCommand.builder).toBeDefined();
    expect(typeof promptCommand.builder).toBe('function');
  });

  it('should define handler function', () => {
    expect(promptCommand.handler).toBeDefined();
    expect(typeof promptCommand.handler).toBe('function');
  });

  it('should configure config and output options in builder', () => {
    let configCalled = false;
    let outputCalled = false;
    const mockYargs = {
      option: (name: string, opts: any) => {
        if (name === 'config') {
          configCalled = true;
          expect(opts.type).toBe('string');
          expect(opts.alias).toBe('c');
        }
        if (name === 'output') {
          outputCalled = true;
          expect(opts.type).toBe('string');
          expect(opts.alias).toBe('o');
        }
        return mockYargs;
      },
    };

    // @ts-expect-error - Mocking yargs
    promptCommand.builder(mockYargs);

    expect(configCalled).toBe(true);
    expect(outputCalled).toBe(true);
  });
});
